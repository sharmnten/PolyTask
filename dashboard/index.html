<!doctype html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PolyTask â€” Dashboard</title>
  <link rel="manifest" href="../manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#4f46e5">
  <meta name="color-scheme" content="light dark">
  <script src="../js/theme-init.js"></script>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><style>path{fill:%23465775}@media(prefers-color-scheme:dark){path{fill:%23a5b4fc}}</style><path d='M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 12l-10-5v2l10 5 10-5v-2l-2.5 1.25L12 11zm0 5l2.5-1.25L12 17l-10-5v2l10 5 10-5v-2l-2.5 1.25L12 16z'/></svg>">
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="./dashboard.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script>window.APPWRITE_ENDPOINT = 'https://nyc.cloud.appwrite.io/v1';</script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@21.4.0"></script>
  <script type="module" src="../js/main.js"></script>
</head>

<body>

  <main class="card calendar-large">
    <div style="display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:1rem;">
      <div id="welcome">
        <h1 id="userGreeting" style="margin:0; font-size:2rem;">Hello!</h1>
        <p id="dateDisplay" style="color:var(--muted); margin-top:0.25rem;">loading...</p>
      </div>
      <div style="display:flex; gap:0.5rem; align-items:center;">
        <!-- Simple Dark Mode Toggle Icon -->
        <label style="cursor:pointer; padding:0.5rem;" title="Toggle Dark Mode">
          <input type="checkbox" id="dmToggle" style="display:none">
          <svg viewBox="0 0 24 24" width="22" height="22" fill="none" class="dm-icon" stroke="currentColor"
            stroke-width="2">
            <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
          </svg>
        </label>
      </div>
    </div>

    <div id="quick-view" class="insight-card">
      <h2 id="motivationalMessage">Welcome back.</h2>
      <p style="opacity:0.9; margin:0;" id="taskSummary">Checking your schedule...</p>
    </div>

    <section class="dashboard-panels">
      <div class="stats-panel" aria-label="Stats">
        <div class="stats-grid">
          <div class="stat-box sandy">
            <h3>Pending</h3>
            <div class="value" id="statPending">-</div>
          </div>
          <div class="stat-box coral">
            <h3>Due Today</h3>
            <div class="value" id="statToday">-</div>
          </div>
          <div class="stat-box mint">
            <h3>Efficiency</h3>
            <div class="value" id="statRate">-</div>
          </div>
          <div class="stat-box violet">
            <h3>Daily Streak</h3>
            <div class="value" id="statStreak">-</div>
          </div>
        </div>
      </div>

      <div class="side-panel" aria-label="Quick add and focus">
        <!-- Quick Add Task -->
        <div class="quick-add" aria-label="Quick add task">
          <div class="quick-add_row">
            <input type="text" id="quickTaskInput" class="quick-add_input"
              placeholder="Quick add task (e.g. 'Read docs for 30m !high #work')">
            <button id="quickAddBtn" class="btn primary quick-add_btn" aria-label="Add task">
              <i class="fas fa-plus" aria-hidden="true"></i>
            </button>
          </div>
          <p class="quick-add_tip">
            Tip: Use <b>!high</b> for priority, <b>#tag</b> for category, <b>30m</b> for duration.
          </p>
        </div>

        <!-- Focus Timer -->
        <div class="stat-box focus-widget" aria-label="Focus timer">
          <div class="focus-items">
            <h3 class="focus-title">Focus Timer</h3>
            <div class="focus-actions">
              <button class="btn primary" onclick="PolyTask.toggleFocus()">Start</button>
              <button class="btn-outline" onclick="PolyTask.resetFocus()">Reset</button>
            </div>
          </div>
          <div class="focus-ring-wrap">
            <svg width="140" height="140" viewBox="0 0 140 140" class="focus-ring-svg">
              <circle cx="70" cy="70" r="60" fill="none" stroke="var(--border-color)" stroke-width="8"></circle>
              <circle id="focusRing" cx="70" cy="70" r="60" fill="none" stroke="var(--accent)" stroke-width="8"
                stroke-dasharray="377" stroke-dashoffset="0" stroke-linecap="round"></circle>
            </svg>
            <div class="focus-ring-center">
              <div id="focusDisplay" class="focus-display">25:00</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <h3 style="color:var(--muted); margin-bottom:1rem;">Quick Actions</h3>
    <div class="action-grid">
      <a href="../calendar/index.html" class="action-btn violet">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <rect x="3" y="4" width="18" height="18" rx="2" ry="2" />
          <line x1="16" y1="2" x2="16" y2="6" />
          <line x1="8" y1="2" x2="8" y2="6" />
          <line x1="3" y1="10" x2="21" y2="10" />
        </svg>
        Planner
      </a>
      <a href="../tasks/index.html" class="action-btn mint">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M9 11l3 3L22 4" />
          <path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11" />
        </svg>
        My Tasks
      </a>
    </div>
    <div class="action-grid" style="margin-top:1rem">
      <a href="../analytics/index.html" class="action-btn coral">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <path d="M4 19h16M4 12h8M4 5h12" />
        </svg>
        View Analytics
      </a>

      <a href="../achievements/index.html" class="action-btn sandy">
        <svg viewBox="0 0 24 24" width="20" height="20" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="8" r="7"></circle>
          <polyline points="8.21 13.89 7 23 12 20 17 23 15.79 13.88"></polyline>
        </svg>
        Achievements
      </a>

      <div class="action-btn cadet" onclick="openSettings()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="12" cy="12" r="3" />
          <path
            d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z" />
        </svg>
        Settings
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 PolyTask. Made with &#10084; by Neal Sharma</p>
  </footer>

  <!-- Settings Modal -->
  <div id="settingsModal" class="modal" role="dialog" aria-modal="true" aria-hidden="true"
    aria-labelledby="settingsTitle">
    <div class="modal_panel" role="document">
      <div class="modal_header">
        <div>
          <h2 id="settingsTitle" class="modal_title">Settings</h2>
          <p class="modal_subtitle">Personalize PolyTask</p>
        </div>
        <button type="button" class="icon-btn modal_close" onclick="closeSettings()"
          aria-label="Close settings">Ã—</button>
      </div>

      <div class="modal_body">
        <section class="settings-section" aria-labelledby="settingsAppearance">
          <h3 id="settingsAppearance">Appearance</h3>
          <label class="settings-row">
            <span class="settings-row_text">
              <span class="settings-label">Dark mode</span>
              <span class="settings-help">Reduce eye strain in low light.</span>
            </span>
            <span class="switch">
              <input type="checkbox" id="darkModeToggle" aria-label="Toggle dark mode">
              <span class="switch_track" aria-hidden="true"></span>
              <span class="switch_thumb" aria-hidden="true"></span>
            </span>
          </label>
        </section>

        <section class="settings-section" aria-labelledby="settingsData">
          <h3 id="settingsData">Data</h3>
          <p class="settings-help" style="margin-top:-0.25rem;">Clean up tasks youâ€™ve already finished.</p>
          <button class="btn-outline settings-danger" type="button" onclick="handleClearCompleted()">Clear completed
            tasks</button>
        </section>

        <section class="settings-section" aria-labelledby="settingsAccount">
          <h3 id="settingsAccount">Account</h3>
          <button class="btn-outline settings-btn" type="button" onclick="PolyTask.logout()">Sign out</button>
        </section>
      </div>

      <div class="modal_footer">
        <button class="btn" type="button" onclick="closeSettings()" style="width:auto;">Done</button>
      </div>
    </div>
  </div>

  <script>
    // XSS protection: escape HTML entities in user-controlled strings
    function escapeHtml(s) {
      return String(s || '').replace(/[&<>"']/g, c => ({
        '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;'
      }[c]));
    }

    const MESSAGES = [
      "Ready to conquer the day?",
      "One task at a time, you've got this.",
      "Consistency is key.",
      "Small steps lead to big focus.",
      "Keep pushing forward.",
      "Your potential is limitless."
    ];

    async function handleClearCompleted() {
      if (!confirm('Are you sure you want to delete all completed tasks? This cannot be undone.')) return;
      const btn = document.querySelector('button[onclick="handleClearCompleted()"]');
      const oldText = btn.textContent;
      btn.textContent = 'Deleting...';
      btn.disabled = true;
      try {
        const count = await PolyTask.clearCompletedTasks();
        alert(`Deleted ${count} tasks.`);
        window.location.reload();
      } catch (e) {
        console.error(e);
        alert('Error clearing tasks.');
        btn.textContent = oldText;
        btn.disabled = false;
      }
    }

    function openSettings() {
      const modal = document.getElementById('settingsModal');
      modal.classList.add('is-open');
      modal.setAttribute('aria-hidden', 'false');
    }

    function closeSettings() {
      const modal = document.getElementById('settingsModal');
      modal.classList.remove('is-open');
      modal.setAttribute('aria-hidden', 'true');
    }

    // Close modal on backdrop click / Escape
    document.addEventListener('click', (e) => {
      const modal = document.getElementById('settingsModal');
      if (!modal?.classList.contains('is-open')) return;
      if (e.target === modal) closeSettings();
    });
    document.addEventListener('keydown', (e) => {
      if (e.key !== 'Escape') return;
      const modal = document.getElementById('settingsModal');
      if (modal?.classList.contains('is-open')) closeSettings();
    });

    document.addEventListener('DOMContentLoaded', async () => {
      // Init PolyTask
      try {
        // Poll for module load
        if (!window.PolyTask) await new Promise(r => {
          const i = setInterval(() => { if (window.PolyTask) { clearInterval(i); r(); } }, 50);
        });

        const user = await PolyTask.getCurrentUser();
        if (!user) {
          window.location.href = '../login/index.html';
          return;
        }

        // 1. Personalized Greeting
        const h = new Date().getHours();
        const timeGreet = h < 12 ? 'Good Morning' : h < 18 ? 'Good Afternoon' : 'Good Evening';
        const name = escapeHtml(user.name) || 'Friend';
        document.getElementById('userGreeting').innerHTML = `${timeGreet}, <span style="color:var(--accent);">${name}</span>`;

        // Date display
        const dateOpts = { weekday: 'long', month: 'long', day: 'numeric' };
        document.getElementById('dateDisplay').textContent = new Date().toLocaleDateString('en-US', dateOpts);

        // 2. Random Motivational Message
        const randMsg = MESSAGES[Math.floor(Math.random() * MESSAGES.length)];
        document.getElementById('motivationalMessage').textContent = randMsg;

        // 3. Stats Calculation
        const tasks = await PolyTask.listUserTasks();
        const pending = tasks.filter(t => !t.complete);
        const todayStr = new Date().toISOString().slice(0, 10);
        const dueToday = pending.filter(t => t.due && t.due.startsWith(todayStr));

        // Efficiency: Last 7 days (based on Due Date)
        const endOb = new Date(); endOb.setHours(23, 59, 59, 999);
        const startOb = new Date(); startOb.setDate(endOb.getDate() - 7); startOb.setHours(0, 0, 0, 0);

        const recentTasks = tasks.filter(t => {
          if (!t.due) return false;
          const d = new Date(t.due);
          return d >= startOb && d <= endOb;
        });
        const recentCompleted = recentTasks.filter(t => t.complete).length;

        // Analytics: weekly window (Mon-Sun based on local)
        const weekStart = new Date();
        weekStart.setHours(0, 0, 0, 0);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay()); // Sunday=0
        const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 7);

        const durationOf = (t) => {
          if (typeof t.estimated_time === 'number' && t.estimated_time > 0) return t.estimated_time;
          if (typeof t.estimateMinutes === 'number' && t.estimateMinutes > 0) return t.estimateMinutes;
          return 30;
        };

        const dateOf = (t) => {
          if (t.assigned) return new Date(t.assigned);
          if (t.due) return new Date(t.due);
          return null;
        };

        const inWeek = tasks.filter(t => {
          const d = dateOf(t);
          return d && d >= weekStart && d < weekEnd;
        });

        const totalMinutesWeek = inWeek.reduce((sum, t) => sum + durationOf(t), 0);
        const doneMinutesWeek = inWeek.filter(t => t.complete).reduce((sum, t) => sum + durationOf(t), 0);
        const completedCountWeek = inWeek.filter(t => t.complete).length;

        // Top category by total minutes this week
        const catMap = new Map();
        inWeek.forEach(t => {
          const cat = t.category || 'General';
          catMap.set(cat, (catMap.get(cat) || 0) + durationOf(t));
        });
        let topCat = 'General';
        let topCatMinutes = 0;
        catMap.forEach((v, k) => { if (v > topCatMinutes) { topCatMinutes = v; topCat = k; } });

        // Planned vs Done percentage
        const planDonePct = totalMinutesWeek ? Math.min(100, Math.round((doneMinutesWeek / totalMinutesWeek) * 100)) : 0;
        const driftMinutes = doneMinutesWeek - totalMinutesWeek; // positive = ahead, negative = behind

        // Completions last 7 days (today + previous 6)
        const dayLabels = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        const today = new Date(); today.setHours(0, 0, 0, 0);
        const days = Array.from({ length: 7 }, (_, i) => {
          const d = new Date(today); d.setDate(today.getDate() - (6 - i)); return d;
        });
        const dayCounts = days.map(d => {
          const next = new Date(d); next.setDate(d.getDate() + 1);
          return tasks.filter(t => {
            if (!t.complete) return false;
            const dd = dateOf(t);
            return dd && dd >= d && dd < next;
          }).length;
        });
        const maxCount = Math.max(1, ...dayCounts);


        // Update analytics UI
        const fmtHours = (mins) => (mins / 60).toFixed(1) + 'h';
        const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
        setText('anTimeWeek', totalMinutesWeek ? fmtHours(totalMinutesWeek) : '0.0h');
        setText('anTopCategoryVal', topCatMinutes ? topCat : 'No data');
        setText('anTopCategoryTime', topCatMinutes ? `${fmtHours(topCatMinutes)} this week` : 'No time logged');

        const todayCompleted = dayCounts[6] || 0;
        setText('anCompletion', todayCompleted.toString());
        setText('anCompletedCount', 'Completed today');
        setText('anPlannedCopy', totalMinutesWeek ? `${fmtHours(doneMinutesWeek)} done / ${fmtHours(totalMinutesWeek)} planned` : 'No planned time yet');
        const fmtDrift = (mins) => {
          const sign = mins === 0 ? '' : (mins > 0 ? '+' : 'â€“');
          const dir = mins > 0 ? 'ahead' : (mins < 0 ? 'behind' : 'on plan');
          return mins === 0 ? 'Drift â€” on plan' : `Drift â€” ${sign}${Math.abs(mins / 60).toFixed(1)}h ${dir}`;
        };
        setText('anDrift', fmtDrift(driftMinutes));
        const bar = document.getElementById('anPlannedBar');
        if (bar) {
          bar.style.width = `${planDonePct}%`;
          const pastelRed = '#f9c2c2';
          const pastelYellow = '#f8e599';
          const pastelGreen = '#b5e4c7';
          let grad = pastelYellow;
          if (planDonePct >= 70) grad = pastelGreen;
          else if (planDonePct <= 40) grad = pastelRed;
          bar.style.background = `linear-gradient(90deg, ${grad}, ${grad})`;
        }

        // Render completion line chart
        const chart = document.getElementById('anCompletionChart');
        if (chart) {
          chart.innerHTML = '';
          const containerW = chart.getBoundingClientRect().width || 360;
          const w = Math.max(containerW, 320);
          const h = 200;
          const padX = 28;
          const padY = 24;
          const stepX = (w - padX * 2) / (dayCounts.length - 1 || 1);
          const usableH = h - padY * 2;
          const baseY = padY + usableH;
          const safeCounts = dayCounts.map(c => Math.max(0, c));
          const safeMax = Math.max(1, ...safeCounts);
          const points = safeCounts.map((count, idx) => {
            const x = padX + idx * stepX;
            const y = padY + usableH - (safeMax ? (count / safeMax) * usableH : 0);
            return { x, y, count };
          });
          if (points.length === 0) points.push({ x: padX, y: baseY, count: 0 });
          // Build smooth path using Catmull-Rom to Bezier approximation (clamped to avoid overshoot below baseline)
          const toPath = (pts) => {
            if (pts.length === 0) return '';
            if (pts.length === 1) return `M${pts[0].x},${pts[0].y}`;
            const path = [`M${pts[0].x},${pts[0].y}`];
            for (let i = 0; i < pts.length - 1; i++) {
              const p0 = i > 0 ? pts[i - 1] : pts[i];
              const p1 = pts[i];
              const p2 = pts[i + 1];
              const p3 = i !== pts.length - 2 ? pts[i + 2] : p2;
              const cp1x = p1.x + (p2.x - p0.x) / 6;
              let cp1y = p1.y + (p2.y - p0.y) / 6;
              const cp2x = p2.x - (p3.x - p1.x) / 6;
              let cp2y = p2.y - (p3.y - p1.y) / 6;
              const clampY = (v) => Math.min(baseY, Math.max(padY, v));
              cp1y = clampY(cp1y);
              cp2y = clampY(cp2y);
              path.push(`C${cp1x},${cp1y} ${cp2x},${cp2y} ${p2.x},${p2.y}`);
            }
            return path.join(' ');
          };
          const linePath = toPath(points);
          const areaPath = `${linePath} L${points[points.length - 1].x},${baseY} L${points[0].x},${baseY} Z`;

          const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
          svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

          const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          area.setAttribute('d', areaPath);
          area.setAttribute('class', 'analytics-area');
          svg.appendChild(area);

          const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
          line.setAttribute('d', linePath);
          line.setAttribute('class', 'analytics-line');
          svg.appendChild(line);

          // Tooltip elements
          const tipGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
          tipGroup.style.display = 'none';
          const tipCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          tipCircle.setAttribute('r', '6');
          tipCircle.setAttribute('fill', '#fff');
          tipCircle.setAttribute('stroke', 'var(--accent)');
          tipCircle.setAttribute('stroke-width', '2');
          const tipBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
          tipBg.setAttribute('rx', '4');
          tipBg.setAttribute('ry', '4');
          tipBg.setAttribute('fill', 'rgba(0,0,0,0.7)');
          const tipText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
          tipText.setAttribute('fill', '#fff');
          tipText.setAttribute('font-size', '12');
          tipText.setAttribute('font-family', 'Inter, system-ui, -apple-system, sans-serif');
          tipText.setAttribute('y', '-8');
          tipGroup.appendChild(tipBg);
          tipGroup.appendChild(tipCircle);
          tipGroup.appendChild(tipText);
          svg.appendChild(tipGroup);

          points.forEach(p => {
            const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
            c.setAttribute('cx', p.x);
            c.setAttribute('cy', p.y);
            c.setAttribute('r', '5');
            c.setAttribute('class', 'analytics-point');
            c.setAttribute('aria-label', p.count);
            c.style.cursor = 'pointer';
            c.addEventListener('click', () => {
              tipGroup.style.display = 'block';
              tipCircle.setAttribute('cx', p.x);
              tipCircle.setAttribute('cy', p.y);
              tipText.textContent = `${p.count}`;
              const bbox = tipText.getBBox();
              const padding = 6;
              tipBg.setAttribute('x', p.x - bbox.width / 2 - padding);
              tipBg.setAttribute('y', p.y - bbox.height - 16);
              tipBg.setAttribute('width', bbox.width + padding * 2);
              tipBg.setAttribute('height', bbox.height + padding * 2);
              tipBg.setAttribute('transform', `translate(0, ${-4})`);
              tipText.setAttribute('x', p.x);
              tipText.setAttribute('y', p.y - bbox.height - 6);
            });
            svg.appendChild(c);
          });

          const labelsRow = document.createElement('div');
          labelsRow.className = 'analytics-xlabels';
          dayCounts.forEach((_, idx) => {
            const d = days[idx];
            const lab = document.createElement('div');
            lab.textContent = `${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}`;
            labelsRow.appendChild(lab);
          });

          chart.appendChild(svg);
          chart.appendChild(labelsRow);

          const todayCount = dayCounts[6];
          const prevAvg = dayCounts.slice(0, 6).reduce((a, b) => a + b, 0) / 6 || 0;
          setText('anCompletionTrend', `Today ${todayCount} vs avg ${prevAvg.toFixed(1)} (prev 6 days)`);
        }

        document.getElementById('statPending').textContent = pending.length;
        document.getElementById('statToday').textContent = dueToday.length;

        const rate = recentTasks.length ? Math.round((recentCompleted / recentTasks.length) * 100) : 0;
        document.getElementById('statRate').textContent = `${rate}%`;

        // Streak
        if (PolyTask.calculateStreak) {
          const streak = PolyTask.calculateStreak(tasks);
          const fire = streak > 0 ? ' ðŸ”¥' : '';
          document.getElementById('statStreak').textContent = streak + fire;

          // Update streak for achievements
          if (typeof PolyTask.updateStreak === 'function') {
            PolyTask.updateStreak(streak);
          }
        }

        // 4. Task Summary Text
        let summary = '';
        if (dueToday.length > 0) {
          const pMap = { high: 3, medium: 2, low: 1 };
          dueToday.sort((a, b) => (pMap[b.priority] || 0) - (pMap[a.priority] || 0));
          const topTask = dueToday[0];
          const pLabel = topTask.priority ? topTask.priority.charAt(0).toUpperCase() + topTask.priority.slice(1) : 'Medium';
          summary = `You have <strong>${dueToday.length}</strong> tasks for today. Your focus is: "<strong>${escapeHtml(topTask.name)}</strong>" <span style="font-size:0.8em;opacity:0.8;background:${topTask.priority === 'high' ? 'var(--accent)' : 'var(--muted)'};color:white;padding:2px 6px;border-radius:4px;">${escapeHtml(pLabel)}</span>.`;
        } else if (pending.length > 0) {
          summary = `No urgent tasks today, but <strong>${pending.length}</strong> pending items in your backlog.`;
        } else {
          summary = "You're all caught up! Enjoy your free time.";
        }
        document.getElementById('taskSummary').innerHTML = summary;

      } catch (e) {
        console.error(e);
      }
    });
  </script>
</body>

</html>