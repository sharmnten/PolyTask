<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PolyTask ‚Äî Achievements</title>
  <link rel="manifest" href="../manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#4f46e5">
  <meta name="color-scheme" content="light dark">
  <script src="../js/theme-init.js"></script>
  <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><style>path{fill:%23465775}@media(prefers-color-scheme:dark){path{fill:%23a5b4fc}}</style><path d='M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 12l-10-5v2l10 5 10-5v-2l-2.5 1.25L12 11zm0 5l2.5-1.25L12 17l-10-5v2l10 5 10-5v-2l-2.5 1.25L12 16z'/></svg>">
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="./achievements.css">
  <script>window.APPWRITE_ENDPOINT = 'https://nyc.cloud.appwrite.io/v1';</script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@21.4.0"></script>
  <script type="module" src="../js/main.js"></script>
  <!-- Expose toast helpers locally for achievement notifications -->
  <script type="module">
    import { showToast, fireConfetti } from '../js/ui.js';
    window.PolyTaskUI = { showToast, fireConfetti };
  </script>
</head>
<body>
  <main class="card calendar-large achievements-container">
    <div class="page-header">
      <h1>Achievements</h1>
      <div class="page-header_actions">
        <label style="cursor:pointer; display:flex; align-items:center;" title="Toggle Dark Mode">
          <input type="checkbox" id="dmToggle" class="dm-toggle" style="display:none">
          <svg viewBox="0 0 24 24" width="20" height="20" fill="none" class="dm-icon" stroke="currentColor" stroke-width="2"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path></svg>
        </label>
        <a href="../calendar/index.html" class="btn-outline" style="text-decoration:none;">Planner</a>
        <a href="../tasks/index.html" class="btn-outline" style="text-decoration:none;">Tasks</a>
        <a href="../dashboard/index.html" class="btn-outline" style="text-decoration:none;">Dashboard</a>
      </div>
    </div>

    <!-- XP & Level Progress -->
    <div class="xp-card">
      <div class="xp-header">
        <div>
          <h2 id="levelTitle">Level 1</h2>
          <p id="levelSubtitle">Novice Tasker</p>
        </div>
        <div class="xp-badge">
          <span id="currentXP">0</span> XP
        </div>
      </div>
      <div class="xp-progress-container">
        <div class="xp-progress-bar">
          <div class="xp-progress-fill" id="xpProgressFill" style="width: 0%"></div>
        </div>
        <p class="xp-text" id="xpText">0 / 100 XP to next level</p>
      </div>
    </div>

    <!-- Stats Overview -->
    <div class="stats-overview">
      <div class="stat-item">
        <div class="stat-icon">üéØ</div>
        <div class="stat-info">
          <span class="stat-value" id="statTasksCompleted">0</span>
          <span class="stat-label">Tasks Completed</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">üî•</div>
        <div class="stat-info">
          <span class="stat-value" id="statCurrentStreak">0</span>
          <span class="stat-label">Day Streak</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">‚è±Ô∏è</div>
        <div class="stat-info">
          <span class="stat-value" id="statFocusTime">0h</span>
          <span class="stat-label">Focus Time</span>
        </div>
      </div>
      <div class="stat-item">
        <div class="stat-icon">üèÜ</div>
        <div class="stat-info">
          <span class="stat-value" id="statAchievementsUnlocked">0</span>
          <span class="stat-label">Achievements</span>
        </div>
      </div>
    </div>

    <!-- Achievements Grid -->
    <div class="achievements-section">
      <h2>All Achievements</h2>
      <div id="achievementsGrid" class="achievements-grid">
        <p style="text-align:center; color:var(--muted);">Loading achievements...</p>
      </div>
    </div>
  </main>

  <footer>
    <p>&copy; 2025 PolyTask. Made with &#10084; by Neal Sharma</p>
    <i class="fab fa-github"></i>
  </footer>

  <script>
    const ACHIEVEMENTS = [
      {
        id: 'first_task',
        title: 'Getting Started',
        description: 'Create your first task',
        icon: 'üéØ',
        xp: 10,
        category: 'beginner',
        condition: (stats) => stats.tasksCreated >= 1
      },
      {
        id: 'task_master_10',
        title: 'Task Master',
        description: 'Complete 10 tasks',
        icon: '‚úÖ',
        xp: 25,
        category: 'progress',
        condition: (stats) => stats.tasksCompleted >= 10
      },
      {
        id: 'task_master_50',
        title: 'Productivity Pro',
        description: 'Complete 50 tasks',
        icon: 'üéñÔ∏è',
        xp: 50,
        category: 'progress',
        condition: (stats) => stats.tasksCompleted >= 50
      },
      {
        id: 'task_master_100',
        title: 'Century Club',
        description: 'Complete 100 tasks',
        icon: 'üíØ',
        xp: 100,
        category: 'progress',
        condition: (stats) => stats.tasksCompleted >= 100
      },
      {
        id: 'task_master_250',
        title: 'Task Legend',
        description: 'Complete 250 tasks',
        icon: 'üèÜ',
        xp: 250,
        category: 'progress',
        condition: (stats) => stats.tasksCompleted >= 250
      },
      {
        id: 'streak_3',
        title: 'Three Day Warrior',
        description: 'Maintain a 3-day streak',
        icon: 'üî•',
        xp: 20,
        category: 'streak',
        condition: (stats) => stats.currentStreak >= 3
      },
      {
        id: 'streak_7',
        title: 'Week Warrior',
        description: 'Maintain a 7-day streak',
        icon: 'üî•üî•',
        xp: 50,
        category: 'streak',
        condition: (stats) => stats.currentStreak >= 7
      },
      {
        id: 'streak_30',
        title: 'Monthly Master',
        description: 'Maintain a 30-day streak',
        icon: 'üî•üî•üî•',
        xp: 150,
        category: 'streak',
        condition: (stats) => stats.currentStreak >= 30
      },
      {
        id: 'streak_100',
        title: 'Centurion',
        description: 'Maintain a 100-day streak',
        icon: '‚ö°',
        xp: 500,
        category: 'streak',
        condition: (stats) => stats.currentStreak >= 100
      },
      {
        id: 'focus_first',
        title: 'Focus Initiate',
        description: 'Complete your first focus session',
        icon: '‚è±Ô∏è',
        xp: 15,
        category: 'focus',
        condition: (stats) => stats.focusSessions >= 1
      },
      {
        id: 'focus_10',
        title: 'Deep Work',
        description: 'Complete 10 focus sessions',
        icon: 'üß†',
        xp: 40,
        category: 'focus',
        condition: (stats) => stats.focusSessions >= 10
      },
      {
        id: 'focus_50',
        title: 'Focus Master',
        description: 'Complete 50 focus sessions',
        icon: 'üéì',
        xp: 100,
        category: 'focus',
        condition: (stats) => stats.focusSessions >= 50
      },
      {
        id: 'focus_time_5',
        title: 'Time Keeper',
        description: 'Log 5 hours of focus time',
        icon: '‚åö',
        xp: 30,
        category: 'focus',
        condition: (stats) => stats.totalFocusMinutes >= 300
      },
      {
        id: 'focus_time_25',
        title: 'Deep Diver',
        description: 'Log 25 hours of focus time',
        icon: 'üèä',
        xp: 75,
        category: 'focus',
        condition: (stats) => stats.totalFocusMinutes >= 1500
      },
      {
        id: 'focus_time_100',
        title: 'Ultra Focused',
        description: 'Log 100 hours of focus time',
        icon: 'üéØ',
        xp: 200,
        category: 'focus',
        condition: (stats) => stats.totalFocusMinutes >= 6000
      },
      {
        id: 'early_bird',
        title: 'Early Bird',
        description: 'Complete a task before 7 AM',
        icon: 'üåÖ',
        xp: 25,
        category: 'special',
        condition: (stats) => stats.earlyBirdTasks >= 1
      },
      {
        id: 'night_owl',
        title: 'Night Owl',
        description: 'Complete a task after 10 PM',
        icon: 'ü¶â',
        xp: 25,
        category: 'special',
        condition: (stats) => stats.nightOwlTasks >= 1
      },
      {
        id: 'perfectionist',
        title: 'Perfectionist',
        description: 'Complete all tasks for a day',
        icon: '‚ú®',
        xp: 50,
        category: 'special',
        condition: (stats) => stats.perfectDays >= 1
      },
      {
        id: 'speed_demon',
        title: 'Speed Demon',
        description: 'Complete 10 tasks in one day',
        icon: '‚ö°',
        xp: 75,
        category: 'special',
        condition: (stats) => stats.maxTasksInDay >= 10
      },
      {
        id: 'organizer',
        title: 'Master Organizer',
        description: 'Use 5 different categories',
        icon: 'üìÇ',
        xp: 30,
        category: 'special',
        condition: (stats) => stats.categoriesUsed >= 5
      }
    ];

    const LEVELS = [
      { level: 1, title: 'Novice Tasker', xpRequired: 0 },
      { level: 2, title: 'Apprentice', xpRequired: 100 },
      { level: 3, title: 'Skilled Worker', xpRequired: 250 },
      { level: 4, title: 'Expert Planner', xpRequired: 500 },
      { level: 5, title: 'Master Organizer', xpRequired: 1000 },
      { level: 6, title: 'Productivity Guru', xpRequired: 2000 },
      { level: 7, title: 'Time Lord', xpRequired: 4000 },
      { level: 8, title: 'Legendary Achiever', xpRequired: 8000 }
    ];

    // Local storage keys
    const STORAGE_KEY = 'polytask_achievements';
    const STATS_KEY = 'polytask_stats';

    function getAchievementData() {
      const stored = localStorage.getItem(STORAGE_KEY);
      if (stored) {
        return JSON.parse(stored);
      }
      return {
        unlockedAchievements: [],
        totalXP: 0
      };
    }

    function saveAchievementData(data) {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
    }

    function getStats() {
      const stored = localStorage.getItem(STATS_KEY);
      if (stored) {
        return JSON.parse(stored);
      }
      return {
        tasksCreated: 0,
        tasksCompleted: 0,
        currentStreak: 0,
        maxStreak: 0,
        focusSessions: 0,
        totalFocusMinutes: 0,
        earlyBirdTasks: 0,
        nightOwlTasks: 0,
        perfectDays: 0,
        maxTasksInDay: 0,
        categoriesUsed: 0
      };
    }

    function calculateLevel(xp) {
      let currentLevel = LEVELS[0];
      for (let i = LEVELS.length - 1; i >= 0; i--) {
        if (xp >= LEVELS[i].xpRequired) {
          currentLevel = LEVELS[i];
          break;
        }
      }
      
      const nextLevelIndex = LEVELS.findIndex(l => l.level === currentLevel.level) + 1;
      const nextLevel = nextLevelIndex < LEVELS.length ? LEVELS[nextLevelIndex] : null;
      
      return {
        current: currentLevel,
        next: nextLevel,
        progress: nextLevel ? xp - currentLevel.xpRequired : 0,
        progressMax: nextLevel ? nextLevel.xpRequired - currentLevel.xpRequired : 0
      };
    }

    async function calculateStatsFromTasks() {
      if (!window.PolyTask) {
        await new Promise(r => {
          const i = setInterval(() => { if(window.PolyTask){clearInterval(i); r();} }, 50);
        });
      }

      const tasks = await window.PolyTask.listUserTasks();
      const completedTasks = tasks.filter(t => t.complete);
      
      // Calculate streak
      const streak = window.PolyTask.calculateStreak ? window.PolyTask.calculateStreak(tasks) : 0;
      
      // Count categories
      const categoriesSet = new Set(tasks.filter(t => t.category).map(t => t.category));
      
      // Check for early bird / night owl tasks
      let earlyBirdCount = 0;
      let nightOwlCount = 0;
      const tasksByDay = {};
      
      completedTasks.forEach(task => {
        if (task.$createdAt) {
          const date = new Date(task.$createdAt);
          const hour = date.getHours();
          if (hour < 7) earlyBirdCount++;
          if (hour >= 22) nightOwlCount++;
          
          // Count tasks per day
          const dayKey = date.toISOString().slice(0, 10);
          tasksByDay[dayKey] = (tasksByDay[dayKey] || 0) + 1;
        }
      });
      
      const maxTasksInDay = Math.max(0, ...Object.values(tasksByDay));
      
      // Get focus data from localStorage
      const focusData = JSON.parse(localStorage.getItem('polytask_focus_log') || '[]');
      const focusSessions = focusData.length;
      const totalFocusMinutes = focusData.reduce((sum, session) => sum + (session.minutes || 0), 0);
      
      return {
        tasksCreated: tasks.length,
        tasksCompleted: completedTasks.length,
        currentStreak: streak,
        maxStreak: Math.max(streak, getStats().maxStreak || 0),
        focusSessions: focusSessions,
        totalFocusMinutes: totalFocusMinutes,
        earlyBirdTasks: earlyBirdCount,
        nightOwlTasks: nightOwlCount,
        perfectDays: 0, // Would need more complex calculation
        maxTasksInDay: maxTasksInDay,
        categoriesUsed: categoriesSet.size
      };
    }

    function checkAndUnlockAchievements(stats) {
      const achievementData = getAchievementData();
      const newUnlocks = [];
      
      ACHIEVEMENTS.forEach(achievement => {
        if (!achievementData.unlockedAchievements.includes(achievement.id)) {
          if (achievement.condition(stats)) {
            achievementData.unlockedAchievements.push(achievement.id);
            achievementData.totalXP += achievement.xp;
            newUnlocks.push(achievement);
          }
        }
      });
      
      saveAchievementData(achievementData);
      localStorage.setItem(STATS_KEY, JSON.stringify(stats));
      
      return { achievementData, newUnlocks };
    }

    function renderAchievements() {
      const achievementData = getAchievementData();
      const stats = getStats();
      
      // Update XP and Level
      const levelInfo = calculateLevel(achievementData.totalXP);
      document.getElementById('levelTitle').textContent = `Level ${levelInfo.current.level}`;
      document.getElementById('levelSubtitle').textContent = levelInfo.current.title;
      document.getElementById('currentXP').textContent = achievementData.totalXP;
      
      if (levelInfo.next) {
        const progressPercent = (levelInfo.progress / levelInfo.progressMax) * 100;
        document.getElementById('xpProgressFill').style.width = `${progressPercent}%`;
        document.getElementById('xpText').textContent = 
          `${levelInfo.progress} / ${levelInfo.progressMax} XP to Level ${levelInfo.next.level}`;
      } else {
        document.getElementById('xpProgressFill').style.width = '100%';
        document.getElementById('xpText').textContent = 'Max Level Reached!';
      }
      
      // Update Stats
      document.getElementById('statTasksCompleted').textContent = stats.tasksCompleted;
      document.getElementById('statCurrentStreak').textContent = stats.currentStreak;
      document.getElementById('statFocusTime').textContent = `${Math.floor(stats.totalFocusMinutes / 60)}h`;
      document.getElementById('statAchievementsUnlocked').textContent = 
        `${achievementData.unlockedAchievements.length}/${ACHIEVEMENTS.length}`;
      
      // Render Achievements Grid
      const grid = document.getElementById('achievementsGrid');
      grid.innerHTML = '';
      
      ACHIEVEMENTS.forEach(achievement => {
        const isUnlocked = achievementData.unlockedAchievements.includes(achievement.id);
        const card = document.createElement('div');
        card.className = `achievement-card ${isUnlocked ? 'unlocked' : 'locked'}`;
        
        card.innerHTML = `
          <div class="achievement-icon">${achievement.icon}</div>
          <div class="achievement-content">
            <h3 class="achievement-title">${achievement.title}</h3>
            <p class="achievement-description">${achievement.description}</p>
          </div>
          <div class="achievement-footer">
            <span class="achievement-xp">+${achievement.xp} XP</span>
            ${isUnlocked ? '<span class="achievement-badge">‚úì</span>' : '<span class="achievement-badge locked-badge">üîí</span>'}
          </div>
        `;
        
        grid.appendChild(card);
      });
    }

    function showUnlockNotification(achievement) {
      // Use global toast for consistent styling across app
      const msg = `${achievement.icon} Achievement Unlocked: ${achievement.title} (+${achievement.xp} XP)`;
      window.PolyTaskUI?.showToast(msg, 'success');
      // Celebrate consistently
      window.PolyTaskUI?.fireConfetti();
    }

    document.addEventListener('DOMContentLoaded', async () => {
      // Wait for PolyTask to be available
      if (!window.PolyTask) {
        await new Promise(r => {
          const i = setInterval(() => { if(window.PolyTask){clearInterval(i); r();} }, 50);
        });
      }
      
      // Load achievements from server first
      try {
        // Try to load from server
        const serverAchievements = await window.PolyTask.loadAchievementsFromServer?.();
        const serverStats = await window.PolyTask.loadStatsFromServer?.();
        
        if (serverAchievements) {
          console.log('Loaded achievements from server');
        }
        if (serverStats) {
          console.log('Loaded stats from server');
        }
      } catch (e) {
        console.warn('Could not load from server:', e);
      }
      
      // Calculate fresh stats from tasks
      const stats = await calculateStatsFromTasks();
      
      // Check for new achievements
      const { achievementData, newUnlocks } = checkAndUnlockAchievements(stats);
      
      // Render everything
      renderAchievements();
      
      // Show notifications for newly unlocked achievements
      newUnlocks.forEach((achievement, index) => {
        setTimeout(() => showUnlockNotification(achievement), index * 500);
      });
    });

    // Export function to check achievements from other pages
    window.PolyTaskAchievements = {
      checkAchievements: async () => {
        const stats = await calculateStatsFromTasks();
        return checkAndUnlockAchievements(stats);
      }
    };
  </script>
</body>
</html>
