<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>PolyTask — Analytics</title>
  <link rel="manifest" href="../manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="theme-color" content="#4f46e5">
  <meta name="color-scheme" content="light dark">
  <script src="../js/theme-init.js"></script>
  <link rel="icon" type="image/svg+xml"
    href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'><style>path{fill:%23465775}@media(prefers-color-scheme:dark){path{fill:%23a5b4fc}}</style><path d='M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 12l-10-5v2l10 5 10-5v-2l-2.5 1.25L12 11zm0 5l2.5-1.25L12 17l-10-5v2l10 5 10-5v-2l-2.5 1.25L12 16z'/></svg>">
  <link rel="stylesheet" href="../styles.css">
  <link rel="stylesheet" href="../dashboard/dashboard.css">
  <link rel="stylesheet" href="./analytics.css">
  <script>window.APPWRITE_ENDPOINT = 'https://nyc.cloud.appwrite.io/v1';</script>
  <script src="https://cdn.jsdelivr.net/npm/appwrite@21.4.0"></script>
  <script type="module" src="../js/main.js"></script>
</head>
<body>
  <main class="card calendar-large analytics-page">
    <div class="page-header">
      <h1>Analytics</h1>

      <a href="../dashboard/index.html" class="btn-outline" style="text-decoration:none;">Dashboard</a>
    </div>

    <div class="analytics-grid">
      <div class="analytics-card">
        <div class="analytics-label">Time This Week</div>
        <div class="analytics-value" id="anTimeWeek">-</div>
        <div class="analytics-sub" id="anTimeWeekSub">Planned time</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-label">Done Today</div>
        <div class="analytics-value" id="anCompletion">-</div>
        <div class="analytics-sub" id="anCompletedCount">Completed today</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-label">Planned vs Done</div>
        <div class="analytics-bar"><span id="anPlannedBar"></span></div>
        <div class="analytics-sub" id="anPlannedCopy">--</div>
        <div class="analytics-sub" id="anDrift">Drift —</div>
      </div>
      <div class="analytics-card">
        <div class="analytics-label">Top Category</div>
        <div class="analytics-value" id="anTopCategoryVal">-</div>
        <div class="analytics-sub" id="anTopCategoryTime">--</div>
      </div>
      <div class="analytics-card analytics-chart-card">
        <div class="analytics-label">Completions (last 7 days)</div>
        <div class="analytics-chart" id="anCompletionChart"></div>
        <div class="analytics-sub" id="anCompletionTrend">Today vs last 6 days</div>
      </div>
    </div>
  </main>

  <script>
    document.addEventListener('DOMContentLoaded', async () => {
      // wait for PolyTask API
      if (!window.PolyTask) await new Promise(r => {
        const i = setInterval(() => { if (window.PolyTask) { clearInterval(i); r(); } }, 40);
      });
      const tasks = await PolyTask.listUserTasks();

      const setText = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
      const fmtHours = (mins) => (mins / 60).toFixed(1) + 'h';

      const durationOf = (t) => {
        if (typeof t.estimated_time === 'number' && t.estimated_time > 0) return t.estimated_time;
        if (typeof t.estimateMinutes === 'number' && t.estimateMinutes > 0) return t.estimateMinutes;
        return 30;
      };
      const dateOf = (t) => {
        if (t.assigned) return new Date(t.assigned);
        if (t.due) return new Date(t.due);
        return null;
      };

      // Week window
      const weekStart = new Date(); weekStart.setHours(0,0,0,0); weekStart.setDate(weekStart.getDate() - weekStart.getDay());
      const weekEnd = new Date(weekStart); weekEnd.setDate(weekStart.getDate() + 7);
      const inWeek = tasks.filter(t => { const d = dateOf(t); return d && d >= weekStart && d < weekEnd; });
      const totalMinutesWeek = inWeek.reduce((s,t)=> s + durationOf(t), 0);
      const doneMinutesWeek = inWeek.filter(t => t.complete).reduce((s,t)=> s + durationOf(t), 0);
      const completedCountWeek = inWeek.filter(t => t.complete).length;

      // Top category
      const catMap = new Map();
      inWeek.forEach(t => { const cat = t.category || 'General'; catMap.set(cat, (catMap.get(cat) || 0) + durationOf(t)); });
      let topCat = 'General', topCatMinutes = 0; catMap.forEach((v,k)=>{ if(v>topCatMinutes){ topCatMinutes=v; topCat=k; } });

      // Planned vs done
      const planDonePct = totalMinutesWeek ? Math.min(100, Math.round((doneMinutesWeek / totalMinutesWeek) * 100)) : 0;
      const driftMinutes = doneMinutesWeek - totalMinutesWeek;

      // Completions over last 7 days (today + prev 6)
      const today = new Date(); today.setHours(0,0,0,0);
      const days = Array.from({length:7}, (_,i)=> { const d = new Date(today); d.setDate(today.getDate() - (6 - i)); return d; });
      const dayCounts = days.map(d => { const next = new Date(d); next.setDate(d.getDate()+1); return tasks.filter(t=> t.complete && dateOf(t) && dateOf(t) >= d && dateOf(t) < next).length; });
      const safeCounts = dayCounts.map(c=> Math.max(0,c)); const safeMax = Math.max(1, ...safeCounts);

      // Bind numbers
      setText('anTimeWeek', totalMinutesWeek ? fmtHours(totalMinutesWeek) : '0.0h');
      setText('anTimeWeekSub', 'Planned time');
      setText('anTopCategoryVal', topCatMinutes ? topCat : 'No data');
      setText('anTopCategoryTime', topCatMinutes ? `${fmtHours(topCatMinutes)} this week` : 'No time logged');
      const todayCompleted = dayCounts[6] || 0;
      setText('anCompletion', todayCompleted.toString());
      setText('anCompletedCount', 'Completed today');
      setText('anPlannedCopy', totalMinutesWeek ? `${fmtHours(doneMinutesWeek)} done / ${fmtHours(totalMinutesWeek)} planned` : 'No planned time yet');
      const fmtDrift = (mins) => {
        const sign = mins === 0 ? '' : (mins > 0 ? '+' : '–');
        const dir = mins > 0 ? 'ahead' : (mins < 0 ? 'behind' : 'on plan');
        return mins === 0 ? 'Drift — on plan' : `Drift — ${sign}${Math.abs(mins/60).toFixed(1)}h ${dir}`;
      };
      setText('anDrift', fmtDrift(driftMinutes));
      const bar = document.getElementById('anPlannedBar');
      if (bar) {
        bar.style.width = `${planDonePct}%`;
        let colorVar = 'var(--maize)'; // mid-range
        if (planDonePct >= 70) colorVar = 'var(--celadon)'; // success
        else if (planDonePct <= 40) colorVar = 'var(--coral)'; // behind
        bar.style.background = colorVar;
      }

      // Draw completion chart
      const chart = document.getElementById('anCompletionChart');
      if (chart) {
        chart.innerHTML = '';
        const containerW = chart.getBoundingClientRect().width || 360;
        const w = Math.max(containerW, 320);
        const h = 200;
        const padX = 28;
        const padY = 24;
        const stepX = (w - padX * 2) / (safeCounts.length - 1 || 1);
        const usableH = h - padY * 2;
        const baseY = padY + usableH;
        const points = safeCounts.map((count, idx) => {
          const x = padX + idx * stepX;
          const y = padY + usableH - (safeMax ? (count / safeMax) * usableH : 0);
          return { x, y, count };
        });
        if (points.length === 0) points.push({ x: padX, y: baseY, count: 0 });

        const toPath = (pts) => {
          if (pts.length === 0) return '';
          if (pts.length === 1) return `M${pts[0].x},${pts[0].y}`;
          const path = [`M${pts[0].x},${pts[0].y}`];
          for (let i = 0; i < pts.length - 1; i++) {
            const p0 = i > 0 ? pts[i - 1] : pts[i];
            const p1 = pts[i];
            const p2 = pts[i + 1];
            const p3 = i !== pts.length - 2 ? pts[i + 2] : p2;
            const cp1x = p1.x + (p2.x - p0.x) / 6;
            let cp1y = p1.y + (p2.y - p0.y) / 6;
            const cp2x = p2.x - (p3.x - p1.x) / 6;
            let cp2y = p2.y - (p3.y - p1.y) / 6;
            const clampY = (v) => Math.min(baseY, Math.max(padY, v));
            cp1y = clampY(cp1y);
            cp2y = clampY(cp2y);
            path.push(`C${cp1x},${cp1y} ${cp2x},${cp2y} ${p2.x},${p2.y}`);
          }
          return path.join(' ');
        };
        const linePath = toPath(points);
        const areaPath = `${linePath} L${points[points.length-1].x},${baseY} L${points[0].x},${baseY} Z`;

        const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
        svg.setAttribute('viewBox', `0 0 ${w} ${h}`);

        const area = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        area.setAttribute('d', areaPath);
        area.setAttribute('class', 'analytics-area');
        svg.appendChild(area);

        const line = document.createElementNS('http://www.w3.org/2000/svg', 'path');
        line.setAttribute('d', linePath);
        line.setAttribute('class', 'analytics-line');
        svg.appendChild(line);

        const tipGroup = document.createElementNS('http://www.w3.org/2000/svg', 'g');
        tipGroup.style.display = 'none';
        const tipCircle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
        tipCircle.setAttribute('r', '5');
        tipCircle.setAttribute('fill', '#fff');
        tipCircle.setAttribute('stroke', 'var(--accent)');
        tipCircle.setAttribute('stroke-width', '2');
        const tipBg = document.createElementNS('http://www.w3.org/2000/svg', 'rect');
        tipBg.setAttribute('rx', '4');
        tipBg.setAttribute('ry', '4');
        tipBg.setAttribute('fill', 'rgba(0,0,0,0.7)');
        const tipText = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        tipText.setAttribute('fill', '#fff');
        tipText.setAttribute('font-size', '12');
        tipText.setAttribute('font-family', 'Inter, system-ui, -apple-system, sans-serif');
        tipText.setAttribute('y', '-8');
        tipGroup.appendChild(tipBg);
        tipGroup.appendChild(tipCircle);
        tipGroup.appendChild(tipText);
        svg.appendChild(tipGroup);

        points.forEach(p => {
          const c = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
          c.setAttribute('cx', p.x);
          c.setAttribute('cy', p.y);
          c.setAttribute('r', '5');
          c.setAttribute('class', 'analytics-point');
          c.setAttribute('aria-label', p.count);
          c.style.cursor = 'pointer';
          c.addEventListener('click', () => {
            tipGroup.style.display = 'block';
            tipCircle.setAttribute('cx', p.x);
            tipCircle.setAttribute('cy', p.y);
            tipText.textContent = `${p.count}`;
            const bbox = tipText.getBBox();
            const padding = 6;
            tipBg.setAttribute('x', p.x - bbox.width/2 - padding);
            tipBg.setAttribute('y', p.y - bbox.height - 16);
            tipBg.setAttribute('width', bbox.width + padding*2);
            tipBg.setAttribute('height', bbox.height + padding*2);
            tipBg.setAttribute('transform', `translate(0, ${-4})`);
            tipText.setAttribute('x', p.x);
            tipText.setAttribute('y', p.y - bbox.height - 6);
          });
          svg.appendChild(c);
        });

        const labelsRow = document.createElement('div');
        labelsRow.className = 'analytics-xlabels';
        safeCounts.forEach((_, idx) => {
          const d = days[idx];
          const lab = document.createElement('div');
          lab.textContent = `${String(d.getMonth()+1).padStart(2,'0')}/${String(d.getDate()).padStart(2,'0')}`;
          labelsRow.appendChild(lab);
        });

        chart.appendChild(svg);
        chart.appendChild(labelsRow);

        const todayCount = dayCounts[6];
        const prevAvg = dayCounts.slice(0,6).reduce((a,b)=>a+b,0) / 6 || 0;
        setText('anCompletionTrend', `Today ${todayCount} vs avg ${prevAvg.toFixed(1)} (prev 6 days)`);
      }
    });
  </script>
</body>
</html>
